<h4>前情提要：从"毛坯房"到"精装修"的AI对话系统进化史</h4> <br><p>在《基于DeepSeek的沉浸式对话网站开发实战(一)》中，我们完成了一个能跑能聊的"毛坯房"版本：</p> <br><ol><li>​<strong>极简三件套</strong>：用纯HTML+CSS+JavaScript搭建骨架，通过fetch直接调用DeepSeek API实现古人对话</li><li>​<strong>角色扮演秘籍</strong>：通过提示词工程（如"你现在是李白，要狂放不羁"）让AI瞬间穿越千年</li><li>​<strong>暴力开发法</strong>：无需训练模型/购买服务器，GitHub Pages一键部署的"丐版"解决方案</li></ol> <br><p>但第一版也暴露了三大"劝退点"：</p> <br><ul><li>​<strong>UI像出土文物</strong>：聊天界面堪比DOS命令行，连发送按钮都像用甲骨文刻的</li><li>​<strong>功能缺胳膊少腿</strong>：没有对话历史保存，每次刷新都像AI得了健忘症</li><li>​<strong>Key裸奔风险</strong>：API密钥直接写在前端代码，黑客看了都想来送"温暖"（敬请期待）</li></ul> <br><p><strong>现在，我们要给这个AI对话系统来次全面整容！​</strong> 第二篇将带来：</p> <br><p>🔮 ​<strong>视觉魔法</strong>：对话气泡动画+角色头像+背景图片，让虚拟人物从文字变成"会动的玩意"<br /> 📦 ​<strong>记忆宫殿</strong>：localStorage存储对话记录，告别"七秒记忆鱼"式聊天</p> <br><p><strong>首先，向大家展示目标实现后的聊天界面</strong></p> <br><p><img alt="" height="596" src="https://i-blog.csdnimg.cn/direct/d31eaa1511fe4519b2b4c59acbb38bbf.jpeg" width="342" /><img alt="" height="595" src="https://i-blog.csdnimg.cn/direct/3fc952256adc4714989f7efc54996c99.jpeg" width="338" /></p> <br><p><strong>是不是很让人心动了，看着这么牛逼的帅哥，你一定想跟他聊上两句</strong></p> <br><p><strong>话不多说，进入正题</strong></p> <br><hr /> <br><h4>💬 ​<strong>聊天气泡代码详解</strong></h4> <br><p><code>BaseCharacter</code> 类中的 <code>displayMessage</code> 方法是聊天气泡的核心实现，负责将用户和AI的消息渲染成<strong>带样式、动画、重说按钮</strong>的对话气泡。以下是关键逻辑：</p> <br><hr /> <br><p>​<strong>1. 气泡生成流程 (<code>displayMessage</code> 方法)</strong></p> <br><pre><code class="language-javascript">displayMessage(message, sender, isRephrase = false) {<br>    const chatContainer = document.getElementById('chat-container');<br>    <br>    // 1️⃣ 半屏模式设置（渐隐效果）<br>    if (localStorage.getItem('halfScreen') === 'true') {<br>        chatContainer.style.maskImage = 'linear-gradient(to bottom, transparent 0%, black 20px, black 100%)';<br>    }<br><br>    // 2️⃣ 创建气泡容器<br>    const messageContainer = document.createElement('div');<br>    messageContainer.classList.add('message-container');<br><br>    // 3️⃣ 创建气泡元素<br>    const messageElement = document.createElement('div');<br>    messageElement.classList.add('message', `${sender}-message`); // 区分用户/AI<br><br>    // 4️⃣ 处理特殊符号（括号、星号变半透明）<br>    const processedMessage = message<br>        .replace(/（([^）]*)）|$([^)]*)$/g, '<span style="opacity:0.6">$&</span>')<br>        .replace(/\*([^*]+)\*/g, '<span style="opacity:0.6">（$1）</span>');<br><br>    messageElement.innerHTML = processedMessage;<br>    messageContainer.appendChild(messageElement);<br><br>    // 5️⃣ 如果是AI消息，添加"重说"按钮<br>    if (sender === 'bot') {<br>        this.addRephraseButton(messageContainer);<br>    }<br><br>    // 6️⃣ 渲染到页面并自动滚动<br>    chatContainer.appendChild(messageContainer);<br>    chatContainer.scrollTop = chatContainer.scrollHeight;<br>}</code></pre> <br><hr /> <br><p>​<strong>2. 核心功能点</strong></p> <br><p>​<strong>📌 样式区分</strong></p> <br><ul><li>​<strong>用户消息</strong>：<code>user-message</code> 类（默认右对齐，浅色背景）</li><li>​<strong>AI消息</strong>：<code>bot-message</code> 类（默认左对齐，深色背景）</li><li>​<strong>半透明标注</strong>：括号 <code>（）</code> 或星号 <code>* *</code> 内容会自动降低透明度（用于动作/语气说明）</li></ul> <br><p>​<strong>📌 动态效果</strong></p> <br><ul><li>​<strong>半屏模式</strong>：<br /> 启用后聊天框高度限制为 <code>50vh</code>，底部添加<strong>渐隐遮罩</strong>​（<code>mask-image</code>），营造卷轴展开效果。（敬请期待）</li></ul> <br><p>​<strong>📌 交互功能</strong></p> <br><ul><li>​<strong>重说按钮</strong>​（仅AI消息）：<br /> 通过 <code>addRephraseButton</code> 方法动态添加按钮，点击后触发 <code>handleRephrase</code> 重新生成回答。 <pre><code class="language-javascript">addRephraseButton(container) {<br>    const btn = document.createElement('button');<br>    btn.textContent = '重说';<br>    btn.onclick = (e) => {<br>        e.stopPropagation();<br>        this.handleRephrase(); // 删除当前消息并重新请求AI<br>    };<br>    container.appendChild(btn);<br>}</code></pre> </li></ul> <br><hr /> <br><p>​<strong>3. CSS 样式关键点（需配合HTML）​</strong></p> <br><p>假设样式文件中定义了以下规则：</p> <br><pre><code class="language-css">/* 气泡基础样式 */<br>.message-container {<br>    margin: 10px;<br>    animation: fadeIn 0.3s ease; /* 淡入动画 */<br>}<br><br>/* 用户气泡（右对齐） */<br>.user-message {<br>    background: #e3f2fd;<br>    border-radius: 18px 18px 0 18px;<br>    padding: 12px;<br>    margin-left: auto;<br>    max-width: 80%;<br>}<br><br>/* AI气泡（左对齐） */<br>.bot-message {<br>    background: #f5f5f5;<br>    border-radius: 18px 18px 18px 0;<br>    padding: 12px;<br>    max-width: 80%;<br>}<br><br>/* 重说按钮 */<br>.rephrase-btn {<br>    background: rgba(0, 123, 255, 0.1);<br>    border: 1px solid #007bff;<br>    border-radius: 4px;<br>    padding: 2px 8px;<br>    font-size: 12px;<br>    margin-top: 5px;<br>}</code></pre> <br><hr /> <br><h4>🎨 ​<strong>总结：气泡设计的核心思想</strong></h4> <br><p>这段代码通过 ​<strong>动态DOM操作 + 语义化CSS</strong> 实现了：</p> <br><ul><li>​<strong>视觉区分</strong>：用户/AI消息左右对立</li><li>​<strong>沉浸感</strong>：半透明标注、渐隐滚动、重说功能</li><li>​<strong>可扩展性</strong>：轻松新增气泡类型（如系统提示、引用回复）</li></ul> <br><p>如果需要更花哨的效果（比如飘落花瓣动画），可以在 <code>message-container</code> 上追加动态类名！</p> <br><hr /> <br><h4>💾 ​<strong>对话历史保存功能详解</strong></h4> <br><p><code>BaseCharacter</code> 类通过 ​<strong>本地存储（localStorage）​</strong> 实现了完整的对话历史保存功能，确保用户刷新页面后仍能恢复之前的对话。以下是核心实现逻辑：</p> <br><p>​<strong>1. 历史记录存储机制</strong></p> <br><p>📌 ​<strong>保存对话 (<code>sendMessage</code> 方法)</strong></p> <br><p>每次AI回复后，会将当前对话记录保存到 <code>localStorage</code>：</p> <br><pre><code class="language-javascript">// 在sendMessage方法中：<br>this.messageHistory.push({ role: "assistant", content: botResponse });<br>localStorage.setItem(`chatHistory_${this.characterName}`, JSON.stringify(this.messageHistory));</code></pre> <br><ul><li>​<strong>键名规则</strong>：<code>chatHistory_角色名</code>（如 <code>chatHistory_李白</code>）</li><li>​<strong>数据结构</strong>：数组格式，每条消息包含 <code>role</code>（user/assistant）和 <code>content</code></li></ul> <br><p>📌 ​<strong>加载历史 (<code>loadHistory</code> 方法)</strong></p> <br><p>初始化时自动加载历史记录：</p> <br><pre><code class="language-javascript">loadHistory() {<br>    const savedHistory = localStorage.getItem(`chatHistory_${this.characterName}`);<br>    if (savedHistory) {<br>        this.messageHistory = JSON.parse(savedHistory);<br>        // 重新渲染每条消息<br>        this.messageHistory.forEach(msg => {<br>            if (msg.role === 'user') this.displayMessage(msg.content, 'user');<br>            else if (msg.role === 'assistant') this.displayMessage(msg.content, 'bot');<br>        });<br>    } else {<br>        this.sendWelcomeMessage(); // 首次对话发送欢迎语<br>    }<br>}</code></pre> <br><hr /> <br><p>​<strong>2. 数据结构示例</strong></p> <br><p>实际存储的 <code>localStorage</code> 数据示例（键：<code>chatHistory_李白</code>）：</p> <br><pre><code class="language-bash">[<br>    {<br>        "role": "system",<br>        "content": "你正在与张三(男)对话。用户人设: 程序员。请以李白的身份和口吻对话..."<br>    },<br>    {<br>        "role": "user",<br>        "content": "李白兄，最近写代码好累啊"<br>    },<br>    {<br>        "role": "assistant",<br>        "content": "（举杯大笑）*痛快！* 代码如诗，不如先饮一杯解忧！"<br>    }<br>]</code></pre> <br><hr /> <br><p>​<strong>3. 清空历史功能</strong></p> <br><p>右上角垃圾桶按钮触发确认弹窗，点击后清除数据：</p> <br><pre><code class="language-javascript">// 在initMusicControls方法中：<br>clearBtn.onclick = () => {<br>    localStorage.removeItem(`chatHistory_${this.characterName}`);<br>    this.messageHistory = [this.systemMessage]; // 重置为仅系统消息<br>    document.getElementById('chat-container').innerHTML = ''; // 清空界面<br>};</code></pre> <br><hr /> <br><p>​<strong>4. 技术亮点</strong></p> <br><ol><li> <p>​<strong>角色隔离存储</strong><br /> 不同角色的对话历史独立保存（<code>chatHistory_角色名</code>），避免互相覆盖。</p> </li><li> <p>​<strong>自动滚动定位</strong><br /> 加载历史后自动滚动到底部（<code>chatContainer.scrollTop = chatContainer.scrollHeight</code>）。</p> </li><li> <p>​<strong>容错处理</strong><br /> 如果 <code>localStorage</code> 读取失败（如用户禁用存储），会自动降级为新建对话。</p> </li></ol> <br><hr /> <br><p>​<strong>5. 实际应用场景</strong></p> <br><table><thead><tr><th>用户操作</th><th>系统行为</th></tr></thead><tbody><tr><td>刷新页面</td><td>自动恢复上次对话</td></tr><tr><td>切换角色</td><td>加载对应角色的历史记录</td></tr><tr><td>点击🗑️按钮</td><td>弹出确认窗 → 清空当前角色历史</td></tr></tbody></table> <br><hr /> <br><h4><strong>🎨 CSS 背景图片 & 头像框内容</strong></h4> <br><p>​<strong>1. 背景图片设置</strong></p> <br><ul><li> <p>​<strong>全局背景</strong>：</p> <pre><code class="language-css">body {<br>    background: url('huoqubing.png') center/cover no-repeat fixed;<br>}</code></pre> <br>  <ul><li>​<strong>效果</strong>：整个页面使用 <code>huoqubing.png</code> 作为背景图，​<strong>居中、覆盖整个视口、不重复、固定不滚动</strong></li><li>​<strong>适用场景</strong>：适合历史人物（如霍去病）的沉浸式对话界面</li></ul> </li><li> <p>​<strong>视频背景（备用）​</strong>：</p> <pre><code class="language-css">#background-video {<br>    position: fixed;<br>    top: 0;<br>    left: 0;<br>    width: 100%;<br>    height: 100%;<br>    object-fit: cover;<br>    z-index: -1;<br>    opacity: 0;<br>    transition: opacity 1s ease;<br>}<br>#background-video.show {<br>    opacity: 1;<br>}</code></pre> <br>  <ul><li>​<strong>功能</strong>：支持动态视频背景（通过JS切换 <code>show</code> 类控制显隐）</li><li>​<strong>交互逻辑</strong>：视频播放时隐藏聊天界面（<code>.video-playing #chat-container</code>）</li></ul> </li></ul> <br><hr /> <br><p>​<strong>2. 头像框设计</strong></p> <br><ul><li> <p>​<strong>顶部标题栏头像</strong>：</p> <pre><code class="language-css">.header-container {<br>    background-color: rgba(0, 0, 0, 0.7);<br>    backdrop-filter: blur(10px);<br>    border: 1px solid rgba(255, 255, 255, 0.2);<br>    display: flex;<br>    align-items: center;<br>    gap: 15px;<br>    padding: 6px 16px;<br>    border-radius: 14px;<br>    position: absolute;<br>    top: 20px;<br>    left: 80px;<br>}<br>.title-avatar {<br>    width: 35px;<br>    height: 35px;<br>    border-radius: 50%;<br>    border: 2px solid rgba(255, 255, 255, 0.5);<br>    object-fit: cover;<br>}</code></pre> <br>  <ul><li>​<strong>样式特点</strong>： <br>    <ul><li>​<strong>圆形头像</strong> + 白色半透明边框</li><li>​<strong>毛玻璃效果</strong>​（<code>backdrop-filter: blur(10px)</code>）</li><li>​<strong>左侧定位</strong>​（与返回按钮配合）</li></ul> </li></ul> </li><li> <p>​<strong>返回按钮</strong>​（搭配头像框和切换回的主页使用）：</p> <pre><code class="language-css">.back-button {<br>    position: absolute;<br>    left: 20px;<br>    top: 20px;<br>    background: rgba(0, 123, 255, 0.5);<br>    border-radius: 50%;<br>    width: 30px;<br>    height: 30px;<br>}</code></pre> </li></ul> <br><hr /> <br><p>​<strong>3. 动态效果</strong></p> <br><ul><li> <p>​<strong>消息渐显动画</strong>：</p> <pre><code class="language-css">.message {<br>    animation: messageFadeIn 0.6s ease-out forwards;<br>    opacity: 0;<br>    transform: translateY(10px);<br>}<br>@keyframes messageFadeIn {<br>    to { opacity: 1; transform: translateY(0); }<br>}</code></pre> <br>  <ul><li>​<strong>作用</strong>：新消息弹出时带<strong>轻微上浮+淡入</strong>效果</li></ul> </li><li> <p>​<strong>视频控制联动</strong>：</p> <pre><code class="language-css">.video-playing #chat-container { opacity: 0; }<br>.video-ended #chat-container { opacity: 1; }</code></pre> <br>  <ul><li>​<strong>逻辑</strong>：播放视频时隐藏聊天框，结束后恢复</li></ul> </li></ul> <br><p><strong>CSS都写完了，那么HTML一切都好说：</strong></p> <br><pre><code class="language-html"><!DOCTYPE html><br><html lang="zh-CN"><br><br><head><br>    <meta charset="UTF-8"><br>    <meta name="viewport" content="width=device-width, initial-scale=1.0"><br>    <title>霍去病</title><br>    <link rel="stylesheet" type="text/css" href="../../styles/common.css"><br>    <link rel="stylesheet" type="text/css" href="huoqubing.css"><br></head><br><br><body><br>    <video id="background-video" preload="auto"><br>        <source src="huoqubing.mp4" type="video/mp4"><br>    </video><br>    <div class="back-button" onclick="location.href='../../index.html'"><br>        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><br>            <path d="M19 12H5M12 19l-7-7 7-7" /><br>        </svg><br>    </div><br><br>    <div class="header-container"><br>        <img src="huoqubinghead.png" class="title-avatar" alt="头像"><br>        <h1>霍去病</h1><br>    </div><br><br>    <div id="chat-container"></div><br><br>    <div id="input-area"><br>        <input type="text" id="user-input" placeholder="输入你的消息..." style="padding-right: 40px;"><br><br>        <button id="send-button">发送</button><br><br>        </div><br>    </div><br>    <script type="module" src="js路径"></script><br><br></body><br><br></html></code></pre> <br><p><strong>好了，现在，你就可以和你喜欢的人物对话了！</strong></p> <br><p></p>