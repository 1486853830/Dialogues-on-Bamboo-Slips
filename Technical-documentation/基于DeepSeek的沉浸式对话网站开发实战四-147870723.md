<h4>​<strong>🌿 前情提要</strong></h4> <br><ul><li>​<strong>第一篇</strong>：搭建「茅檐竹舍」——基础对话框架</li><li>​<strong>第二篇</strong>：雕琢「曲栏回廊」——视觉与记忆系统</li><li>​<strong>第三篇</strong>：营造「亭台楼阁」——角色广场与多智能体</li></ul> <br><p>而今，我们要为这座「AI园林」注入灵魂——<strong>让AI识人辨性，对答如流</strong>！</p> <br><hr /> <br><h4>​<strong>🎋 本期核心功能</strong></h4> <br><h5>​<strong>1. 【用户人设档案】- 以「观人术」定制应答</strong></h5> <br><ul><li>用户首次进入时填写《人物小传》（性格、喜好、身份）</li><li>AI根据档案调整措辞风格，如： <br>  <ul><li>对「豪侠」用「兄台」「痛快」等词</li><li>对「闺秀」用「芳驾」「雅鉴」等敬语</li></ul> </li></ul> <br><h5>​<strong>2. 【重说功能】- 「一言既出，回炉再造」​</strong></h5> <br><ul><li>用户点击「重说」按钮</li><li>AI根据对话上下文生成3种不同风格的备选回答</li></ul> <br><h5>​3.<strong> 【预设回答】- 「锦囊妙计，随时取用」​</strong></h5> <br><ol><li>读取用户历史对话（上文）并读取用户人设</li><li>生成符合语境的用户回答语句</li></ol> <br><h5>​4. <strong>【智能开场白】- 「未见其人，先闻其声」​</strong></h5> <br><ol><li>读取用户历史对话（如上次讨论过「边塞诗」）或者读取用户人设</li><li>生成符合人设的问候语： <br>  <ul><li>对武将：「将军近日校场演武，可有新得？」</li><li>对隐士：「山居清幽，先生可采得新茶？」</li></ul> </li></ol> <br><hr /> <br><h4>🎭 ​1.<strong>用户人设档案</strong></h4> <br><h5>📜 ​<strong>HTML部分：古风表单的现代演绎</strong></h5> <br><pre><code class="language-html"><div class="settings-group"><br>    <div class="settings-item"><br>        <label for="user-name">江湖名号：</label><br>        <input type="text" id="user-name" placeholder="如：琅琊王十二" class="settings-input"><br>    </div></code></pre> <br><p><strong>🤖 代码趣解</strong>：</p> <br><ul><li>这个<code><input></code>就像武侠小说里的"英雄帖"，等着用户签下自己的江湖名号</li><li><code>placeholder</code>里的"琅琊王十二"是在暗示："看！这里有个现成的贵族马甲可以穿"</li><li><code>settings-input</code>类名暴露了它的真实身份——披着古风外衣的现代输入框</li></ul> <br><pre><code class="language-html">    <select id="user-gender" class="settings-input"><br>        <option value="公子">公子</option><br>        <option value="娘子">娘子</option><br>    </select></code></pre> <br><p><strong>🎭 趣味观察</strong>：</p> <br><ul><li>这个<code><select></code>是AI的"望气术"工具，用来判断用户是"公子"还是"娘子"</li><li>没有"太监"选项说明AI很懂历史——太监不能随便当啊！</li><li>默认选中第一个选项，暗示AI内心OS："我赌五毛钱你是个公子哥儿"</li></ul> <br><h5>🌟 ​<strong>JavaScript部分：AI的识人秘籍</strong></h5> <br><p><strong>存储函数</strong>：</p> <br><pre><code class="language-javascript">function saveSettings() {<br>    localStorage.setItem('userName', <br>        document.getElementById('user-name').value.trim());<br>}</code></pre> <br><p><strong>🔍 幽默解读</strong>：</p> <br><ul><li><code>trim()</code>是在帮用户"修剪"多余空格，就像店小二擦掉招牌上的灰尘</li><li>如果用户输入" 王十二 "，AI会贴心记成"王十二"，仿佛在说："知道啦知道啦，不用加空格强调"</li><li><code>localStorage</code>是AI的"江湖记事本"，专门记录各路英雄的特征</li></ul> <br><p><strong>⚔️ 彩蛋发现</strong>：</p> <br><ul><li><code>includes()</code>方法像在玩"关键词抓阄"游戏</li><li>只检测到"游侠"就问宝剑，万一人家是"飞刀游侠"呢？AI这波有点刻板印象了</li><li>建议加个<code>else</code>："若检测不到关键词，就问'近日可有什么奇遇？'，万能模板！"</li></ul> <br><h5>💡 <strong>数据流动就像江湖传言</strong></h5> <br><ol><li> <p>表单输入 → 如同在茶楼登记名帖</p> </li><li> <p>localStorage存储 → 像店小二把信息记在账簿上</p> </li><li> <p>AI读取使用 → 如同小二见到熟客立刻笑脸相迎</p> </li></ol> <br><h5><strong>🤖 对话实现​</strong></h5> <br><pre><code class="language-javascript">if (messageHistory.length === 1) {<br>    messageHistory[0].content = `你正在与${localStorage.getItem('userName') || '访客'}(${localStorage.getItem('userGender') || 'unknown'})对话。<br>    用户人设: ${localStorage.getItem('userPersona') || ''}<br>    请以${messageHistory[0].content.split('作为')[1].split('，')[0]}的身份和口吻进行对话。<br>    你需要主动推动故事情节发展，在回复中：<br>    内容简短不超过50字，动作神态等内容用括号括上`;<br>}</code></pre> <br><p><strong>🔍 趣味解析</strong>：</p> <br><ul><li>这段代码如同给AI角色颁发"官凭告身"，将用户户籍黄册郑重呈上<br /> <code>localStorage.getItem()</code>恰似师爷翻阅鱼鳞册籍，<code>|| '访客'</code>则是给未具名的来客发放临时牙牌<br /> 用<code>split('作为')[1]</code>截取角色封号，宛若上官训示："休论前文繁冗，尔今领受的职衔乃是XX！"<br /> 限定"动作神态用括号"——犹如礼部颁发的《仪注规条》，着令AI依礼制行事</li></ul> <br><h5>📱 效果演示</h5> <br><h5><img alt="" height="220" src="https://i-blog.csdnimg.cn/direct/7dc7138b35534fcc9f5d4e0f16130332.bmp" width="338" /><img alt="" height="220" src="https://i-blog.csdnimg.cn/direct/c0ee207da34940a0a4934590df77c2e2.bmp" width="334" /></h5> <br><hr /> <br><h4>🎭 ​<strong>​2.重说功能</strong></h4> <br><h5>​<strong>1. 按钮创建（<code>addRephraseButton</code>）​</strong></h5> <br><pre><code class="language-javascript">const rephraseBtn = document.createElement('button');<br>rephraseBtn.textContent = '重说';<br>rephraseBtn.classList.add('rephrase-btn');<br>rephraseBtn.onclick = (e) => {<br>    e.stopPropagation();  // 阻止事件冒泡（防误触）<br>    handleRephrase();     // 触发核心功能<br>};</code></pre> <br><p><strong>🔍 趣味解析</strong></p> <br><ul><li>像给AI对话界面装了个"时光沙漏"按钮</li><li><code>stopPropagation()</code>相当于对系统说："这个错我认定了，别劝我！"</li><li>按钮样式类<code>rephrase-btn</code>暗示这是VIP级别的后悔特权</li></ul> <br><h5>​<strong>2. 核心逻辑（<code>handleRephrase</code>）​</strong></h5> <br><pre><code class="language-javascript">if (messageHistory.length >= 2 && <br>    messageHistory[messageHistory.length - 1].role === "assistant") {<br>    <br>    // 删除最近两条记录（用户提问+AI回复）<br>    messageHistory.pop(); // 扔掉AI回复<br>    const userMessage = messageHistory.pop(); // 取出用户问题<br>    <br>    // 删除界面元素<br>    const messages = chatContainer.querySelectorAll('.message-container');<br>    chatContainer.removeChild(messages[messages.length - 1]); // 删AI气泡<br>    chatContainer.removeChild(messages[messages.length - 2]); // 删用户气泡<br>    <br>    return userMessage; // 返回待重说的用户消息<br>}</code></pre> <br><p><strong>⚙️ 技术亮点</strong></p> <br><ol><li> <p>​<strong>双重验证</strong></p> <br>  <ul><li>检查消息记录长度<code>>=2</code></li><li>确认最后一条是AI回复（防误删用户消息）</li></ul> </li><li> <p>​<strong>同步清理</strong></p> <br>  <ul><li>内存数据（<code>messageHistory</code>数组）</li><li>DOM元素（界面气泡）双线操作</li></ul> </li><li> <p>​<strong>数据回传</strong><br /> 返回原始用户消息，方便重新触发对话流程</p> </li></ol> <br><h5>​<strong style="color:#4f4f4f; font-weight:bold">​</strong><strong style="color:#4f4f4f">🎨 设计哲学</strong></h5> <br><ol><li> <p>​<strong>非破坏性操作</strong></p> <br>  <ul><li>先备份<code>userMessage</code>再删除</li><li>类似git的<code>rebase</code>而非强制推送</li></ul> </li><li> <p>​<strong>视觉即时反馈</strong><br /> 删除DOM元素让用户立即看到"时光倒流"效果</p> </li><li> <p>​<strong>状态一致性</strong><br /> 确保内存数据与界面显示严格同步</p> </li></ol> <br><hr /> <br><h4>🎭 ​3.<strong>预设回答功能</strong></h4> <br><h5>​<strong>1. 核心逻辑 (<code>getPresetResponse</code>)</strong></h5> <br><pre><code class="language-javascript">const response = await fetch("https://api.deepseek.com/v1/chat/completions", {<br>    method: "POST",<br>    headers: {<br>        "Authorization": `Bearer ${API_KEY}` // 手持令牌叩响AI府门<br>    },<br>    body: JSON.stringify({<br>        messages: [<br>            ...messageHistory, // 呈上过往对话卷宗<br>            {<br>                role: "user",<br>                content: `生成3个回复${characterName}的选项...` // 递上特制奏折<br>            }<br>        ],<br>        temperature: 1 // 开启文思泉涌模式<br>    })<br>})</code></pre> <br><p><strong>🔍 精妙之处</strong>：</p> <br><ul><li>采用<code>...messageHistory</code>展开语法，如同展开"对话长卷"</li><li><code>temperature:1</code>参数让AI的回复更具创意性，犹如翰林院学士微醺作诗</li><li>严格限定回复格式（数字序号+括号动作描写），像科举考试的"八股文格式"</li></ul> <br><h5>​<strong>2. 响应处理</strong></h5> <br><pre><code class="language-javascript">const options = content.split('\n')<br>    .filter(line => line.match(/^\d\./)) // 只取带序号的"圣旨条目"<br>    .map(line => line.replace(/^\d\.\s*/, '').trim()) // 去除序号如太监宣读圣旨时去掉"奉天承运"<br>    .slice(0, 3); // 只取前三策</code></pre> <br><p><strong>⚙️ 技术亮点</strong>：</p> <br><ul><li>正则表达式<code>/^\d\./</code>像"朱批御览"，只选中格式正确的条目</li><li><code>trim()</code>如同裁掉奏折多余的空白绫边</li><li>保底机制确保总有3个选项，好比殿试必取三甲</li></ul> <br><h5>​<strong>3. HTML组件</strong></h5> <br><pre><code class="language-html"><div id="pull-up-menu" <br>     style="display: none; <br>            backdrop-filter: blur(100px); /* 琉璃屏风效果 */<br>            border: 1px solid rgba(255,255,255,0.15)"> <!-- 描金边框 --><br>    <div style="display: flex; flex-direction: column; gap: 8px;"><br>        <button class="preset-btn" data-text="你好！">你好！</button> <!-- 锦囊标签 --><br>    </div><br></div></code></pre> <br><p><strong>🎨 设计巧思</strong>：</p> <br><ul><li><code>backdrop-filter: blur(100px)</code>创造毛玻璃效果，宛如透过云母屏风看选项</li><li><code>data-text</code>属性暗藏机锋，点击时直接取出文本无需解析</li><li>固定底部60px的位置设计，既不会遮挡输入框，又符合"垂手可得"的人体工学</li></ul> <br><p><img alt="" height="567" src="https://i-blog.csdnimg.cn/direct/2f49047138044760a0fbb74dcc132d92.bmp" width="581" /></p> <br><hr /> <br><h4>🎭 ​智能开场白功能</h4> <br><h5>​⚜️ 核心流程</h5> <br><pre><code class="language-javascript">const response = await fetch("https://api.deepseek.com/v1/chat/completions", {<br>    body: JSON.stringify({<br>        messages: [{<br>            role: "system",<br>            content: `作为${characterName}，向${localStorage.getItem('userName')}打招呼...` <br>        }],<br>        temperature: 0.9 // 控制文风稳定性<br>    })<br>})</code></pre> <br><p><strong>🔮 设计精妙</strong>：</p> <br><ul><li>​<strong>角色扮演系统</strong>：通过<code>作为${characterName}</code>严格设定AI身份，如同古代"职衔拜帖"</li><li>​<strong>三重用户档案调用</strong>： <pre><code class="language-javascript">${localStorage.getItem('userName') || '访客'} // 姓名<br>(${localStorage.getItem('userGender') || 'unknown'}) // 性别称谓<br>"${localStorage.getItem('userPersona') || ''}" // 人设标签</code></pre> 活似门房唱名时查阅的"宾客录"</li><li>​<strong>温度参数</strong>：<code>temperature:0.9</code>在稳定与创意间取得平衡，如同礼部既守仪制又允变通</li></ul> <br><h5>​<strong>🎨 交互细节</strong></h5> <br><ol><li> <p>​<strong>加载动画</strong></p> <pre><code class="language-javascript">const loadingElement = document.createElement('div');<br>loadingElement.className = 'loading-spinner'; // 创建"礼乐进行中"动画</code></pre> <br>  <ul><li>模拟古代"候客茶盏"的等待体验</li><li>技术实现：需配合CSS设计旋转的青铜爵造型</li></ul> </li><li> <p>​<strong>消息显示</strong></p> <pre><code class="language-javascript">displayMessage(chatContainer, welcomeMessage, 'bot', 0);<br>chatContainer.scrollTop = chatContainer.scrollHeight;</code></pre> <br>  <ul><li>自动滚动确保新消息可见，如同堂前小厮及时展开新到的拜帖</li><li>'bot'参数控制消息居左显示，符合"主左客右"的传统礼仪</li></ul> </li><li> <p>​<strong>数据持久化（详见</strong><a class="link-info" href="https://blog.csdn.net/H1486853830/article/details/147702174" title="《基于DeepSeek的沉浸式对话网站开发实战(二）》">《基于DeepSeek的沉浸式对话网站开发实战(二）》</a><strong>）</strong></p> <pre><code class="language-javascript">localStorage.setItem(`chatHistory_${characterName}`, ...);</code></pre> <br>  <ul><li>为每个角色建立独立存档，类似"各殿起居注"分册记录</li><li>键名模板字符串确保隔离性，避免"曹操读到牛顿语录"的时空错乱</li></ul> </li></ol> <br><h5>​<strong>📜 提示词工程</strong></h5> <br><pre><code class="language-javascript">content: `作为${characterName}...包含动作描写（用括号标注）...100字左右`</code></pre> <br><p><strong>精妙约束</strong>：</p> <br><ul><li>​<strong>括号动作</strong>：<code>（拂袖）</code>等描写增强沉浸感</li><li>​<strong>字数控制</strong>：避免冗长如奏折，保持门房传话的简洁</li><li>​<strong>禁引号</strong>：防止AI生成<code>"欢迎光临"</code>等生硬表达</li></ul> <br><h5>​<strong>🎭 示例输出</strong></h5> <br><p><img alt="" height="580" src="https://i-blog.csdnimg.cn/direct/77d5c644f4f245278c3e1f718a078715.jpeg" width="328" /><img alt="" height="580" src="https://i-blog.csdnimg.cn/direct/2dac00e7f3f640adad78cedce0257e6f.jpeg" width="327" /></p> <br><hr /> <br><h4>🏯 ​本篇<strong>结语：从代码到「数字人文宫殿」的建造史诗</strong></h4> <br><h5>​<strong>🌌 一、技术宇宙中的文明复刻</strong></h5> <br><ol><li> <p>​<strong>​「重说」如时光回溯</strong></p> <br>  <ul><li>剑形按钮斩断时空，三版应答似「三策献君」，赋予对话以历史抉择的重量</li><li>正则表达式<code>/^\d\./</code>如朱批御览，确保AI的「奏对」合乎礼制</li></ul> </li><li> <p>​<strong>​「预设回答」若锦囊妙计</strong></p> <br>  <ul><li>毛玻璃菜单暗藏「屏风选秀」之美，<code>backdrop-filter</code>渲染出古典朦胧</li><li><code>temperature:1</code>让AI化身微醺翰林，在格式枷锁中迸发诗性</li></ul> </li><li> <p>​<strong>​「开场白」乃礼部仪注</strong></p> <br>  <ul><li><code>localStorage</code>的鱼鳞册与<code>|| '访客'</code>的牙牌制度，构建数字时代的称谓体系</li><li>括号动作描写<code>（拂袖）</code>，恰似戏曲程式动作的代码转译</li></ul> </li></ol> <br><h5><br /> ​<strong>🎭 二、设计哲学的破壁对话</strong></h5> <br><ol><li>​<strong>非对称美感：</strong>用户输入自由如狂草，AI应答格式严谨如馆阁体，在约束中见创造力</li><li>​<strong>状态同步玄机</strong>：<code>localStorage</code>与DOM操作如「起居注」与「实录」双轨并行，确保史笔无讹</li></ol> <br><h5>​<strong>🚀 三、终极启示</strong></h5> <br><p>这套系统实为「数字礼乐」：</p> <br><ul><li>​<strong>前端如礼器</strong>：<code>displayMessage</code>的泡泡框是青铜爵，半屏模式是展开的竹简</li><li>​<strong>后端似礼制</strong>：<code>fetch</code>请求如同诸侯觐见，<code>API_KEY</code>便是通关虎符</li><li>​<strong>异常处理若礼官</strong>：在崩溃边缘依然执圭而立，道一声"客官稍候"</li></ul> <br><p>至此，这座用代码垒砌的「数字人文宫殿」已然基本落成。它不仅实现了功能，更用技术演绎了<strong>「科技有温度」</strong>的终极命题——而这，才是真正的「智能豪宅」。</p> <br><p>接下来，我们将对各项功能进行<strong>细化拓展</strong></p> <br><p>欢迎大家在评论区交流讨论！</p> <br><p></p>